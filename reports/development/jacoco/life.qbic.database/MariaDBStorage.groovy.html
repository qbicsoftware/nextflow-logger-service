<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MariaDBStorage.groovy</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nxflogger</a> &gt; <a href="index.source.html" class="el_package">life.qbic.database</a> &gt; <span class="el_source">MariaDBStorage.groovy</span></div><h1>MariaDBStorage.groovy</h1><pre class="source lang-java linenums">package life.qbic.database

import groovy.json.JsonOutput
import groovy.json.JsonSlurper
import groovy.sql.GroovyRowResult
import groovy.sql.Sql
import groovy.util.logging.Log4j2
import life.qbic.Constants
import life.qbic.service.WeblogStorage
import life.qbic.micronaututils.QBiCDataSource
import life.qbic.model.WeblogMessage
import life.qbic.model.weblog.MetaData
import life.qbic.model.weblog.RunInfo
import life.qbic.model.weblog.Trace

import javax.inject.Inject
import javax.inject.Singleton
import java.sql.Clob
import java.text.DateFormat
import java.text.SimpleDateFormat

@Log4j2
@Singleton
class MariaDBStorage implements WeblogStorage, AutoCloseable{

<span class="nc" id="L26">    private static final DateFormat databaseDateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;)</span>

<span class="nc" id="L28">    private static final DateFormat utcDateFormat = new SimpleDateFormat(Constants.ISO_8601_DATETIME_FORMAT)</span>

    private QBiCDataSource dataSource

    private Sql sql

    @Inject MariaDBStorage(QBiCDataSource dataSource) {
<span class="nc" id="L35">        this.dataSource = dataSource</span>
<span class="nc" id="L36">    }</span>

    List&lt;Trace&gt; findTracesForRunWithId(String id) {
<span class="nc" id="L39">        sql = new Sql(dataSource.connection)</span>
<span class="nc" id="L40">        try {</span>
<span class="nc bnc" id="L41" title="All 4 branches missed.">            def result = tryToFetchTracesForRun(id)</span>
<span class="nc" id="L42">            return result</span>
<span class="nc" id="L43">        } catch (Exception e) {</span>
<span class="nc" id="L44">            throw new WeblogStorageException(&quot;Could not fetch trace information for run with id $id.&quot;, e.fillInStackTrace())</span>
<span class="nc" id="L45">        }</span>
<span class="nc" id="L46">    }</span>

    private List&lt;Trace&gt; tryToFetchTracesForRun(String runId) {
<span class="nc bnc" id="L49" title="All 4 branches missed.">        def resultRows = tryToFindWeblogEntryWithRunId(runId)</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">        if( resultRows.size() &gt; 1 ) {</span>
<span class="nc" id="L51">            throw new WeblogStorageException(&quot;More than one run found for id $runId!. Expected unique result.&quot;)</span>
        }
<span class="nc" id="L53">        def primaryKeyRun = resultRows.get(0)[&quot;ID&quot;] as Integer</span>
<span class="nc" id="L54">        def traces = findTracesForRunWithPrimaryKey(primaryKeyRun)</span>
<span class="nc" id="L55">        return traces</span>
<span class="nc" id="L56">    }</span>

    private List&lt;Trace&gt; findTracesForRunWithPrimaryKey(Integer key) {
<span class="nc" id="L59">        def result = sql.rows(&quot;&quot;&quot;SELECT * FROM traces WHERE runId=$key;&quot;&quot;&quot;)</span>
<span class="nc" id="L60">        List&lt;Trace&gt; traces = result.collect{ convertRowResultToTrace(it) }</span>
<span class="nc" id="L61">        return traces</span>
<span class="nc" id="L62">    }</span>

    private static Trace convertRowResultToTrace(GroovyRowResult row) {
<span class="nc" id="L65">        return new Trace([&quot;task_id&quot;: row.get('TASKID'),</span>
<span class="nc" id="L66">            &quot;start&quot;: row.get('STARTTIME'),</span>
<span class="nc" id="L67">            &quot;submit&quot;: row.get('SUBMISSIONTIME'),</span>
<span class="nc" id="L68">            &quot;name&quot;: row.get('NAME'),</span>
<span class="nc" id="L69">            &quot;status&quot;: row.get('STATUS'),</span>
<span class="nc" id="L70">            &quot;exit&quot;: row.get('EXIT'),</span>
<span class="nc" id="L71">            &quot;attempt&quot;: row.get('ATTEMPT'),</span>
<span class="nc" id="L72">            &quot;memory&quot;: row.get('MEMORY'),</span>
<span class="nc" id="L73">            &quot;duration&quot;: row.get('DURATION'),</span>
<span class="nc" id="L74">            &quot;cpus&quot;: row.get('CPUS'),</span>
<span class="nc" id="L75">            &quot;queue&quot;: row.get('QUEUE')])</span>
<span class="nc" id="L76">    }</span>

    List&lt;RunInfo&gt; findRunWithRunId(String runId) {
<span class="nc" id="L79">        sql = new Sql(dataSource.connection)</span>
<span class="nc" id="L80">        try {</span>
<span class="nc bnc" id="L81" title="All 4 branches missed.">            def result = tryToFindWeblogEntryWithRunId(runId)</span>
<span class="nc" id="L82">            def weblogMessages = result.collect { convertRowResultToRunInfo(it) }</span>
<span class="nc" id="L83">            sql.close()</span>
<span class="nc" id="L84">            return weblogMessages</span>
<span class="nc" id="L85">        } catch (Exception e) {</span>
<span class="nc" id="L86">            sql.close()</span>
<span class="nc" id="L87">            throw new WeblogStorageException(&quot;Could not query weblog message with run id $runId! Reason: $e&quot;, e.fillInStackTrace())</span>
<span class="nc" id="L88">        }</span>
<span class="nc" id="L89">    }</span>

    private List&lt;GroovyRowResult&gt; tryToFindWeblogEntryWithRunId(String runId) {
<span class="nc" id="L92">        final def statement = &quot;SELECT * FROM runs WHERE runId='${runId}';&quot;</span>
<span class="nc" id="L93">        return sql.rows(statement)</span>
<span class="nc" id="L94">    }</span>

    private static RunInfo convertRowResultToRunInfo(GroovyRowResult rowResult) {
<span class="nc" id="L97">        RunInfo info = new RunInfo()</span>
<span class="nc" id="L98">        info.id = rowResult.get(&quot;RUNID&quot;)</span>
<span class="nc" id="L99">        info.status = rowResult.get(&quot;LASTEVENT&quot; )</span>
<span class="nc" id="L100">        info.name = rowResult.get(&quot;NAME&quot;)</span>
<span class="nc bnc" id="L101" title="All 4 branches missed.">        info.time = utcDateFormat.parse(toUTCTime(rowResult.get(&quot;LASTRECORD&quot;) as String))</span>
<span class="nc" id="L102">        return info</span>
<span class="nc" id="L103">    }</span>

    void storeWeblogMessage(WeblogMessage message) throws WeblogStorageException{
<span class="nc" id="L106">       this.sql = new Sql(dataSource.connection)</span>
        try {
<span class="nc" id="L108">            tryToStoreWeblogMessage(message)</span>
<span class="nc" id="L109">            sql.close()</span>
<span class="nc" id="L110">        } catch (Exception e) {</span>
<span class="nc" id="L111">            sql.close()</span>
<span class="nc" id="L112">            throw new WeblogStorageException(&quot;Could not store weblog message: $message! Reason: $e&quot;, e.fillInStackTrace())</span>
<span class="nc" id="L113">        }</span>
<span class="nc" id="L114">    }</span>

    private void tryToStoreWeblogMessage(WeblogMessage message) {
<span class="nc" id="L117">        def primaryKeyRun = storeRunInfo(message.runInfo)</span>
<span class="nc" id="L118">        insertTraceInfo(message.trace, primaryKeyRun)</span>
<span class="nc" id="L119">        insertMetadataInfo(message.metadata, primaryKeyRun)</span>
<span class="nc" id="L120">    }</span>

    private void insertMetadataInfo(MetaData metaData, Integer primaryKeyRun) {
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if( metaData == new MetaData() ) {</span>
<span class="nc" id="L124">            return</span>
        }
<span class="nc" id="L126">        sql.execute(&quot;&quot;&quot;insert into metadata (runId,</span>
            startTime, parameters, workDir, container, user, manifest,
            revision, duration, success, resume, nextflowVersion, exitStatus, errorMessage) 
            values (
                $primaryKeyRun,
<span class="nc" id="L131">                ${ utcDateFormat.parse(metaData.workflow.'start' as String) },</span>
<span class="nc" id="L132">                ${JsonOutput.toJson(metaData.params)},</span>
                ${metaData.workflow.'workDir'},
                ${metaData.workflow.'container'},
                ${metaData.workflow.'userName'},
<span class="nc" id="L136">                ${JsonOutput.toJson(metaData.workflow.'manifest')},</span>
                ${metaData.workflow.'revision'},
                ${metaData.workflow.'duration'},
                ${metaData.workflow.'success'},
                ${metaData.workflow.'resume'},
                ${metaData.workflow.'nextflow'.'version'},
                ${metaData.workflow.'exitStatus'},
                ${metaData.workflow.'errorMessage'}
            );&quot;&quot;&quot;)
<span class="nc" id="L145">    }</span>

    private Integer storeRunInfo(RunInfo runInfo) {
<span class="nc" id="L148">        def primaryKey</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if( isRunInfoStored(runInfo) ) {</span>
<span class="nc" id="L150">            primaryKey = updateWeblogRunInfo(runInfo)</span>
<span class="nc" id="L151">        } else {</span>
<span class="nc" id="L152">            primaryKey = insertWeblogRunInfo(runInfo)</span>
        }
<span class="nc" id="L154">        return primaryKey</span>
<span class="nc" id="L155">    }</span>

    private boolean isRunInfoStored(RunInfo runInfo) {
<span class="nc" id="L158">        return tryToFindWeblogEntryWithRunId(runInfo.id)</span>
<span class="nc" id="L159">    }</span>

    private Integer updateWeblogRunInfo(RunInfo runInfo){
<span class="nc" id="L162">        sql.execute(&quot;&quot;&quot; update runs set lastEvent = ${runInfo.event.toString()}, \</span>
                lastRecord = ${runInfo.time} where runId = ${runInfo.id} and name = ${runInfo.name};&quot;&quot;&quot;)
<span class="nc" id="L164">        def result = tryToFindWeblogEntryWithRunId(runInfo.id)</span>
<span class="nc" id="L165">        return result[0].get('id') as Integer</span>
<span class="nc" id="L166">    }</span>

    private Integer insertWeblogRunInfo(RunInfo runInfo) {
<span class="nc" id="L169">        sql.execute(&quot;&quot;&quot;insert into runs (runId, name, lastEvent, lastRecord) values \</span>
            ($runInfo.id,
            $runInfo.name,
<span class="nc" id="L172">            ${runInfo.event.toString()},</span>
            ${ runInfo.time });&quot;&quot;&quot;)
<span class="nc" id="L174">        def result = tryToFindWeblogEntryWithRunId(runInfo.id)</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">        if( !result ) {</span>
<span class="nc" id="L176">            throw new WeblogStorageException(&quot;Insertion went wrong!&quot;)</span>
        }
<span class="nc" id="L178">        return result[0].get('id') as Integer</span>

<span class="nc" id="L180">    }</span>

    private void insertTraceInfo(Trace trace, Integer primaryKeyRun) {
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if( trace == new Trace() )</span>
<span class="nc" id="L184">            return</span>
<span class="nc" id="L185">        sql.execute(&quot;&quot;&quot;insert into traces (taskId, runId, startTime, submissionTime, name, `status`, `exit`, attempt, memory, cpus, queue, duration) values \</span>
            (${trace.'task_id'},
            $primaryKeyRun,
            ${trace.'start'},
            ${trace.'submit'},
            &quot;${trace.'name'}&quot;,
            &quot;${trace.'status'}&quot;,
            ${trace.'exit'},
            ${trace.'attempt'},
            ${trace.'memory'},
            ${trace.'cpus'},
            &quot;${trace.'queue'}&quot;,
            ${trace.'duration'});&quot;&quot;&quot;)
<span class="nc" id="L198">    }</span>

    List&lt;MetaData&gt; findMetadataForRunWithId(String id) {
<span class="nc" id="L201">        sql = new Sql(dataSource.connection)</span>
<span class="nc" id="L202">        try {</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">            def result = tryToFetchMetadataForRun(id)</span>
<span class="nc" id="L204">            return result</span>
<span class="nc" id="L205">        } catch (Exception e) {</span>
<span class="nc" id="L206">            throw new WeblogStorageException(&quot;Could not retrieve metadata information for run with id: $id. Reason: $e&quot;, e.fillInStackTrace())</span>
<span class="nc" id="L207">        }</span>
<span class="nc" id="L208">    }</span>

    private List&lt;MetaData&gt; tryToFetchMetadataForRun(String runId) {
<span class="nc bnc" id="L211" title="All 4 branches missed.">        def resultRows = tryToFindWeblogEntryWithRunId(runId)</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if( resultRows.size() &gt; 1 ) {</span>
<span class="nc" id="L213">            throw new WeblogStorageException(&quot;More than one run found for id $runId!. Expected unique result.&quot;)</span>
        }
<span class="nc" id="L215">        def primaryKeyRun = resultRows.get(0)[&quot;ID&quot;] as Integer</span>
<span class="nc" id="L216">        return findMetadataForRunWithForeignKey(primaryKeyRun)</span>
<span class="nc" id="L217">    }</span>

    private List&lt;MetaData&gt; findMetadataForRunWithForeignKey(Integer key) {
<span class="nc" id="L220">        def result = sql.rows(&quot;SELECT * FROM metadata WHERE runId=$key;&quot;)</span>
<span class="nc" id="L221">        List&lt;MetaData&gt; metadata = result.collect{ convertRowResultToMetadata(it) }</span>
<span class="nc" id="L222">        return metadata</span>
<span class="nc" id="L223">    }</span>

    private static MetaData convertRowResultToMetadata(GroovyRowResult rowResult) {
<span class="nc" id="L226">        def slurper = new JsonSlurper()</span>
<span class="nc bnc" id="L227" title="All 4 branches missed.">        def workflow = [</span>
<span class="nc" id="L228">                'start': toUTCTime(rowResult.get('STARTTIME') as String),</span>
<span class="nc" id="L229">                'workDir': rowResult.get('WORKDIR'),</span>
<span class="nc" id="L230">                'container': rowResult.get('CONTAINER'),</span>
<span class="nc" id="L231">                'userName': rowResult.get('USER'),</span>
<span class="nc" id="L232">                'manifest': slurper.parseText(parseClob(rowResult.get('MANIFEST') as Clob)),</span>
<span class="nc" id="L233">                'revision': rowResult.get('REVISION'),</span>
<span class="nc" id="L234">                'duration': rowResult.get('DURATION'),</span>
<span class="nc" id="L235">                'success': rowResult.get('SUCCESS'),</span>
<span class="nc" id="L236">                'resume': rowResult.get('RESUME'),</span>
<span class="nc" id="L237">                'model': ['version': rowResult.get('NEXTFLOWVERSION')],</span>
<span class="nc" id="L238">                'exitStatus': rowResult.get('EXITSTATUS'),</span>
<span class="nc" id="L239">                'errorMessage': rowResult.get('ERRORMESSAGE')</span>
        ]


<span class="nc" id="L243">        return new MetaData([</span>
<span class="nc" id="L244">                'params': slurper.parseText(parseClob(rowResult.get('PARAMETERS') as Clob)),</span>
                'workflow': workflow
        ])
<span class="nc" id="L247">    }</span>

    private static String parseClob(Clob clob) {
<span class="nc" id="L250">        Reader reader = clob.getCharacterStream()</span>
<span class="nc" id="L251">        return reader.getText()</span>
<span class="nc" id="L252">    }</span>

    private static String toUTCTime(String timestamp) {
<span class="nc" id="L255">        log.info(timestamp)</span>
<span class="nc" id="L256">        Date parsedDate = databaseDateFormat.parse(timestamp)</span>
<span class="nc" id="L257">        log.info(parsedDate)</span>
<span class="nc" id="L258">        return parsedDate.format(Constants.ISO_8601_DATETIME_FORMAT)</span>
<span class="nc" id="L259">    }</span>

    @Override
    void close() throws Exception {
<span class="nc" id="L263">        sql.close()</span>
<span class="nc" id="L264">        dataSource.connection.close()</span>
<span class="nc" id="L265">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>